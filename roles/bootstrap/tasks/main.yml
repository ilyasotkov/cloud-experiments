- name: Generate SSH keys and known_hosts file for the swarm controller.
  block:
    - file:
        path: "{{ local_path }}/ssh"
        state: directory

    - shell: |
        ssh-keygen -b 2048 -t rsa \
        -f {{ local_path }}/ssh/id_rsa \
        -N '' \
        -C "{{ controller_ssh_key_comment }}"
      args:
        creates: "{{ local_path }}/ssh/id_rsa"

    - shell: |
        ssh-keyscan "{{ hostvars['leader_manager'].ansible_host }}" \
        >> {{ local_path }}/ssh/known_hosts
      args:
        creates: "{{ local_path }}/ssh/known_hosts"

    - file:
        path: /root/.ssh
        state: directory

    - shell: grep "\$ANSIBLE_VAULT" {{ local_path }}/ssh/id_rsa
      register: ssh_local_key_encrypted
      failed_when: "ssh_local_key_encrypted.rc == 2"
    - shell: ansible-vault encrypt {{ local_path }}/ssh/id_rsa /root/.ssh/id_rsa
      args:
        chdir: "{{ local_path }}"
      when: not ssh_local_key_encrypted.stdout
